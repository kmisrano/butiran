<!DOCTYPE html>
<html>
	<head>
		<meta charset="ISO-8859-1">
		<title>RBC Granular</title>
		<script src="../grains/vect3old.js"></script>
		<script src="../grains/grainblood.js"></script>
		<script src="../grains/force.js"></script>
		<script src="../grains/mdynamics.js"></script>
		<script src="../grains/draw2d.js"></script>
	</head>
	<body>
		<script>
			/*
			2D Simulation of Red Blood Cell
			Sparisoma Viridi | dudung@gmail.com
			Ismi Yasifa | yasifa.ismi@gmail.com
			
			20180327
			Redefine forces constants and integrate layout.
			20180413
			Calculate initial length between particle.
			Calculate torque between particle.
			*/

			// Redefine some constants from force.js
			kG = 5E0;
			kR = 1E5;
			kV = 1.0;
			kE = 1.0;
			kV2 = 0.8;
			
			// Redefine some constants from dynamics.js
			dt = 0.01;
			
			var timer1;
			var N = 50;
			var grains = new Array(N);
			var R = 2;
			var Rx = 1.2 * R;
			var Ry = 0.6 * R;
			var delta_teta = 2 * Math.PI / N;
			var l1 = new Array(N);
			var l2 = new Array(N);
			var theta = new Array(N);
			var kr = 3;
			var kt = 1;
			
			var it = 0;
			var Nt = 100;
			
			layout();
			initiate();
			
			function initiate() {
				Mdynamics.setdt(1E-3);
				
				var m = 5;
				var I = m*R*R;
				var c = "#f00";
				var D = 2;
				var x0 = 0;
				var y0 = 0;
				
				var teta = new Array(N);
				for(var i = 1; i <= N; i++) {
					teta[i] = (i-1) * delta_teta;
					var x = x0 + (Rx * Math.cos(teta[i]));
					var y = y0 + (Ry * Math.sin(teta[i]));
						grains[i] = new Grain;
						grains[i].i = i;
						grains[i].r = new Vect3(x, y, 0);
						var cR = 128;
						var cG = (16 - i) * 16;
						var cB = i * 16;
						grains[i].m = m;
						grains[i].I = I;
						grains[i].c = c;
						grains[i].D = 0.25 * D;
				}
				
				//Calculate initial length between particle
				for(var i = 1; i <= N; i++) {
					l1[i] = new Array(N);
					l2[i] = new Array(N);
					for(var j = 1; j <= N; j++) {
						if (Math.abs(j-i)==1 || Math.abs(j-i)==N-1) { //between one particle
							l1[i][j] = Vect3.len(Vect3.sub(grains[i].r, grains[j].r));
						} else if (Math.abs(j-i)==2 || Math.abs(j-i)==N-2) { //between two particle
							l2[i][j] = Vect3.len(Vect3.sub(grains[i].r, grains[j].r));
						}
					}
				}
				
				//Calculate angle between particle
				// Function for define angle between Vect3
				ang = function(r1, r2, r3) {
					var a = Vect3.dot(Vect3.sub(r1,r2), Vect3.sub(r1,r3));
					var l1 = Vect3.len(Vect3.sub(r1,r2));
					var l2 = Vect3.len(Vect3.sub(r1,r3));
					var angle = Math.acos(a/(l1*l2));
					return angle;
				}
				
				for(var i = 1; i <= N; i++) {
					theta[i] = new Array(N);
					for(var j = 1; j <= N; j++) {
						if (Math.abs(j-i)==2 || Math.abs(j-i)==N-2) {
							if (Math.abs(j-i)==N-2) {
								if (i==1 || j==1) {
									theta[i][j] = ang(grains[N].r, grains[1].r, grains[N-1].r);
								} else  if (i==2 || j==2) {
									theta[i][j] = ang(grains[1].r, grains[2].r, grains[N].r);
								}
							} else {
								if (i>j) {
									theta[i][j] = ang(grains[i-1].r, grains[i].r, grains[j].r);
								} else {
									theta[i][j] = ang(grains[i+1].r, grains[i].r, grains[j].r);
								}
							}
						}
					}
				}
				
				for(var iN = 1; iN <= N; iN++) {
					plotParticle(grains[iN]);
				}
			}
			
			function run() {
				// Prepare variabel for saving sum of forces
				var SF = new Array(N);
				var ST = new Array(N);
				var k;
				var l;
				
				for(var iN = 1; iN <= N; iN++) {
					SF[iN] = new Vect3;
				}
				
				//Initial kinetic energy
				var EKi = 0;
				if(it > Nt) {
					for(var iN = 1; iN <= N; iN++) {
						var v = Vect3.len(grains[iN].v);
						var m = grains[iN].m;
						var EK = 0.5 * m * v * v;
						EKi += EK;
					}
				}
				
				// Calculate spring force
				for(var iN = 1; iN <= N; iN++) {
					//console.log("Partikel " + iN);
					ST[iN] = 0;
					for(var jN = 1; jN <= N; jN++) {
						//console.log("Partikel " + jN);
						if (iN!=jN) {
							if (Math.abs(jN-iN)==1 || Math.abs(jN-iN)==N-1) {
								var f = new Vect3;
								k = kr;
								l = 0.9*l1[iN][jN];
								f = Force.spring(grains[iN], grains[jN], k, l);
								//console.log(f);
								SF[iN] = Vect3.add(SF[iN], f);
							} else if (Math.abs(jN-iN)==2 || Math.abs(jN-iN)==N-2) {							
								k = kt;
								th = 0.92*theta[iN][jN];
								var torq = k*(theta[iN][jN]-th);
								ST[iN] += torq;
								var leng = Vect3.len(Vect3.sub(grains[iN].r, grains[jN].r));
								var f_torq = torq/leng;
								var f_torq_y = f_torq * Math.cos(theta[iN][jN]);
								var f_torq_x = f_torq * Math.sin(theta[iN][jN]);
								var f = new Vect3(f_torq_x, f_torq_y, 0);
								//console.log(f);
								SF[iN] = Vect3.add(SF[iN], f);
							}
						}
					}
				}
				
				/* // Calculate viscous force
				for(var iN = 1; iN <= N; iN++) {
					var f = new Vect3(Force.visc(grains[iN]));
					SF[iN] = Vect3.add(SF[iN], f);
				} */
				
				clearCurrentFigure();
				for(var i = 1; i <= N; i++) {
					plotParticle(grains[i]);
				}
				
				for(var i = 1; i <= N; i++) {
					for(var j = 1; j <= N; j++) {
						var alpha = ST[i]/grains[i].I;
						theta[i][j] += grains[i].w*dt;
						grains[i].w += alpha*dt;
					}
				}
				for(var i = 1; i <= N; i++) {
					Mdynamics.Euler(SF[i], grains[i]);
				}
				Mdynamics.inct();

				//Final kinetic energy
				var EKf = 0;
				var rEK = 1; //Kinetic energy ratio
				if(it > Nt) {
					for(var iN = 1; iN <= N; iN++) {
						var v = Vect3.len(grains[iN].v);
						var m = grains[iN].m;
						var EK = 0.5 * m * v * v;
						EKf += EK;
					}
					rEK = Math.sqrt(EKi / EKf);
				}
				
				it++;
				if(it > Nt) {
					it = 0;
					for(var iN = 1; iN <= N; iN++) {
						var v = Vect3.mul(grains[iN].v, rEK);
						grains[iN].v = v;
					}
				}
				
				/* var rpm = new Vect3;
				for(var iN = 1; iN <= N; iN++) {
					var r = grains[iN].r;
					rpm = Vect3.add(rpm, r);
				}
				rpm = Vect3.div(rpm, N);
				
				var Ravg = 0;
				for(var iN = 1; iN <= N; iN++) {
					var r = grains[iN].r;
					Ravg += Vect3.len(Vect3.sub(r, rpm));
				}
				Ravg /= N; //Average radius of red blood cell */
				
				var str = "t = " + t + " s" + " " + EKi + " " + EKf + " " ;
				var hout = document.getElementById("hout");
				hout.innerHTML = str;
				
			}

			/*
				layout.js
				Define layout for simulation.
				Sparisoma Viridi | dudung@gmail.com
				
				20170215
				Start this library.
				20180327
				Delete this file and move content to blood_cell_2d_model.html
			*/

			function layout() {
				// Create left division
				var ldiv = document.createElement("div");
				document.body.appendChild(ldiv);
				ldiv.style.border = "0px black solid";
				ldiv.style.height = "402px";
				ldiv.style.float = "left";
				ldiv.style.width = "252px";
				
				// Create right division
				var rdiv = document.createElement("div");
				document.body.appendChild(rdiv);
				rdiv.style.border = "0px black solid";
				rdiv.style.height = "402px";
				rdiv.style.float = "left";
				
				// Create text area for input
				var ta = document.createElement("textarea");
				ldiv.appendChild(ta);
				ta.style.color = "black";
				ta.style.background = "white";
				ta.rows = "20";
				ta.cols = "32";
				ta.style.overflowY = "scroll";
				ta.style.display = "block";	
				ta.id = "hout";
				
				// Create canvas for drawing
				var c = document.createElement("canvas");
				rdiv.appendChild(c);
				c.id = "canvas";
				c.style.border = "1px solid #999";
				c.style.background = "white";
				c.width = "400";
				c.height = "400";
				//c.style.float = "left";
				var ctx = c.getContext("2d");
				
				// Prepare canvas
				setCanvasCoordinates("canvas");
				setWorldCoordinates(-10, -10, 10, 10);
				
				// Create start button
				var b1 = document.createElement("button");
				ldiv.appendChild(b1);
				b1.innerHTML = "Start";
				b1.onclick = function() {
					if(b1.innerHTML == "Start") {
						b1.innerHTML = "Stop";
						timer1 = setInterval(run, 1);
					} else {
						b1.innerHTML = "Start";
						clearInterval(timer1);
					}
				}
				
				// Create save Button
				var b2 = document.createElement("button");
				ldiv.appendChild(b2);
				b2.innerHTML = "Save";
				b2.onclick = function() {
					var canvas = document.getElementById("canvas");
					var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
					window.location.href = image;
				}
			}
						
		</script>
	</body>
</html>