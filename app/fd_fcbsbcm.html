<!doctype html>
<!--
	fd_fcbsbcm.html
	Fast charging battery simulation based on capacitor model
	
	Sparisoma Viridi | dudung@gmail.com
	Felix Pasila | felix@petra.ac.id
	Hendro | hendro@fi.itb.ac.id
	
	Execute: node fcbs.js
	
	Version info:
		Node.js	v10.1.0
	
	20180512
	Create this application as empty HTML file.
	20180513
	Start to build the layout.
	20180518
	Continue developing the application.
	20180520
	Change filename from app/capacitor_charging.html to
	app/butiran/app/fast_charging_battery.js as part of
	butiran.js project, and move the old one into sandbox.
	20180929
	Change name according to new naming convention and port italic
	to html.
	20180930
	Do some adjustment while porting it to html version.
	
	CDN
	https://rawgit.com/dudung/butiran/master/app/fd_fcbsbcm.html
-->
<html>
<head><script src="_butiran.js"></script></head>
<body>
<script>


// Define some global variables
var t, dt, tbeg, tend;
var digit;
var ptn1, ptn2;
var seq1, seq2;
var amp1, amp2;
var R, C, T, Tint, Rmin, Rmax, Rint, q;
var SG;

var Tdata, sample;
var proc;
var tabs1, tabs2, bgroup;
var coordMin, coordMax;

// Call main function
main()

// Define main function
function main() {
	// Set layout of elements
	setLayout();
	
	// Set timer for processing simulation
	proc = new Timer(simulate, 1);
}

// Perform simulation
function simulate() {

	// Format time t
	t = +t.toFixed(10);
	
	// Show data header in Results tab
	if(t < tbeg + dt) {
		tabs1.text("Results").push("# t\tVs\tRC\tVC\n");
	}
	
	// Perform simulation
	var signal = SG.ping();
	var V = signal[2];
	var r = Rint.ping(dt, V);
	
	var q1 = q * (1 - dt / (C * (R + r)));
	var q2 = (C * V * dt) / (C * (R + r));
	q = q1 + q2;
	
	var VC = C * q;
	
	var linestr = t.toFixed(digit) + "\t";
	linestr += V + "\t";
	linestr += r.toFixed(digit) + "\t";
	linestr += VC.toExponential(digit);
	
	tabs1.text("Results").push(linestr);
	var taRes = tabs1.element("Results");
	taRes.scrollTop = taRes.scrollHeight;
	
	// Display result in certain period of time
	if(sample.sampling()) {
		
		// Clear drawing area
		tabs2.graphic("xy").clear();
		
		// Draw waving fluid surface
		tabs2.graphic("xy").setLineColor("#00f");	
		//tabs2.graphic("xy").lines(xf, yf);
		
		// Draw spherical particle
		tabs2.graphic("xy").setLineColor("#f00");	
		//tabs2.graphic("xy").strokeCircle(r.x, r.y, 0.5 * D);
	}
	
	// Terminate simulation when end time is reached
	if(t >= tend) {
		proc.stop();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Simulation stopped t = tend");
		bgroup.disable("Start");
		bgroup.setCaption("Start").to("Start");
		bgroup.enable("Draw");
	}
	
	// Increase time t
	t += dt;
}

// Set layout of elements
function setLayout() {
	// Create title page
	var p = document.createElement("p");
	p.innerHTML = "Fast charging battery simulation " +
		"based on capacitor model";
	p.style.fontWeight = "bold";
	document.body.append(p);

	// Define first Tabs --add "document.body" to avoid warning
	tabs1 = new Tabs("tabs1", "document.body");
	tabs1.setWidth("450px");
	tabs1.setHeight("300px");
	tabs1.addTab("Log", 0);
	tabs1.addTab("Params", 0);
	tabs1.addTab("Results", 0);
	
	// Define second Tabs --add "document.body" to avoid warning
	tabs2 = new Tabs("tabs2", "document.body");
	tabs2.setWidth("300px");
	tabs2.setHeight("300px");
	tabs2.addTab("xy", 1);
	
	// Clear all tabs --add "document.body" to avoid warning
	tabs1.text("Params").clear();
	tabs1.text("Results").clear();
	tabs1.text("Log").clear();
	tabs2.graphic("xy").clear();

	// Define bgroup
	bgroup = new Bgroup("bgroup", "document.body");
	bgroup.setWidth("60px");
	bgroup.setHeight("147px");
	bgroup.addButton("Clear");
	bgroup.addButton("Load");
	bgroup.addButton("Read");
	bgroup.addButton("Start");
	bgroup.addButton("Draw");
	bgroup.addButton("Help");
	bgroup.addButton("About");
	bgroup.disable("Read");
	bgroup.disable("Start");
	bgroup.disable("Draw");
}

// Load parameters
function loadParameters() {
	tabs1.text("Params").push("# Components");
	tabs1.text("Params").push("RESISTOR 10");
	tabs1.text("Params").push("CAPACITOR 0.001");
	tabs1.text("Params").push("TINT 0.2");
	tabs1.text("Params").push("RMIN 100");
	tabs1.text("Params").push("RMAX 1000");
	tabs1.text("Params").push();
	
	tabs1.text("Params").push("# Simulation");
	tabs1.text("Params").push("TSTEP 0.001");
	tabs1.text("Params").push("TDATA 1E-1");
	tabs1.text("Params").push("TBEG 0");
	tabs1.text("Params").push("TEND 10");
	tabs1.text("Params").push();
	
	tabs1.text("Params").push("# Visualization");
	tabs1.text("Params").push("COORDMIN -1 -1 -1");
	tabs1.text("Params").push("COORDMAX 1 1 1");
	var ta = tabs1.element("Params");
	ta.scrollTop = ta.scrollHeight;
}
	
// Get parameters
function readParameters() {
	var text = tabs1.element("Params").value;
	
	R = Parse.getFrom(text).valueOf("RESISTOR");
	C = Parse.getFrom(text).valueOf("CAPACITOR");
	T = R * C;
	Tint = Parse.getFrom(text).valueOf("TINT");
	Rmin = Parse.getFrom(text).valueOf("RMIN");
	Rmax = Parse.getFrom(text).valueOf("RMAX");
	Rint = new Resistor(Rmin, Rmax, Tint);
	q = 0;
	
	dt = Parse.getFrom(text).valueOf("TSTEP");
	Tdata = Parse.getFrom(text).valueOf("TDATA");
	tbeg = Parse.getFrom(text).valueOf("TBEG");
	tend = Parse.getFrom(text).valueOf("TEND");
	t = tbeg;
	
	// -------------------- manually set --------------------
	// Define significant digit
	digit = -Math.floor(Math.log(dt) / Math.exp(1));

	// Define pattern for sequence as voltage source
	ptn1 = [
		0, 0, 0, 0, 0,
		1, 1, 1, 1, 1,
	]; // 10 ms
	ptn2 = [
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
	]; // 100 ms
	/*
	var ptn2 = [
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
		1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
		1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
	]; // 100 ms
	*/
	
	// Define sequences
	seq1 = new Sequence(ptn1);
	seq2 = new Sequence(ptn2);

	// Define signal amplitudo
	amp1 = 10; // V
	amp2 = 20; // V
	
	// Create a signal generator with two output signals
	SG = new Generator(dt, [seq1, seq2], [amp1, amp2]);
	// ------------------------------------------------------

	coordMin = Parse.getFrom(text).valueOf("COORDMIN");
	coordMax = Parse.getFrom(text).valueOf("COORDMAX");
	
	// Initiate time
	t = tbeg;
	
	// Set sampling
	sample = new Sample(Tdata, dt);
	
	// Set coordinate ranges
	tabs2.graphic("xy").setCoord(
		[coordMin.x, coordMin.y, coordMax.x, coordMax.y]);
}	

// Log something and show manually	
function log() {
	try { 
		console.log(
			showOnly(logjs).forFilter(
				{
					app: "spfwfs",
					date: "20180714",
					after: "0500",
				}
			)
		);
	}
	catch(err) {
		var msg = "opsebf logs only in development stage";
		console.warn(msg);
	}
}

// Do something when buttons clicked
function buttonClick(event) {
	var target = event.target;
	
	if(target.innerHTML == "Start") {
		target.innerHTML = "Stop";
		proc.start();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Simulation is starting");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
		bgroup.disable("Draw");
	} else if(target.innerHTML == "Stop"){
		target.innerHTML = "Start";
		proc.stop();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Simulation stopped");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
		bgroup.enable("Draw");
	}
	
	if(target.innerHTML == "About") {
		alert(
			"fd_fcbsbcm | "
			+ "Fast charging battery simulation " 
			+ "based on capacitor model"
			+ "\n"
			+ "Version 20180929"
			+ "\n"
			+ "Sparisoma Viridi | dudung@gmail.com"
			+ "\n"
			+ "Felix Pasila | felix@petra.ac.id"
			+ "\n"
			+ "Hendro | hendro@fi.itb.ac.id"
			+ "\n"
			+ "\n"
			+ "Based on butiran "
			+ "| https://github.com/dudung/butiran"
			+ "\n"
			+ "MIT License | "
			+ "Copyright (c) 2018 Sparisoma Viridi"
		);
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "About is called");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
	}
	
	if(target.innerHTML == "Help") {
		alert(""
			+ "[Clear]    clear all text and graphic\n"
			+ "[Load]     load default parameters\n"
			+ "[Read]     read parameters from text\n"
			+ "[Start]     start simulation\n"
			+ "[Draw]     draw results\n"
			+ "[Help]     show this help\n"
			+ "[About]   describe this application\n"
		);
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Help is called");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
	}
	
	if(target.innerHTML == "Load") {
		tabs1.text("Params").clear();
		loadParameters();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Default parameters are loaded");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
		bgroup.enable("Read");
	}
	
	if(target.innerHTML == "Read") {
		readParameters();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Parameters are read");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
		bgroup.enable("Start");
	}
	
	if(target.innerHTML == "Clear") {
		tabs1.text("Params").clear();
		tabs1.text("Results").clear();
		tabs1.text("Log").clear();
		tabs2.graphic("xy").clear();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Parameters, Results, "
			+ "and Log are cleared");
		tabs1.text("Log").push(ts + "xy "
			+ "is cleared");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
		bgroup.disable("Read");
		bgroup.disable("Start");
	}
	
	if(target.innerHTML == "Draw") {
		drawResults();
		var ts = Timer.ts() + "|";
		tabs1.text("Log").push(ts + "Results will be drawn");
		var ta = tabs1.element("Log");
		ta.scrollTop = ta.scrollHeight;
	}
}

// Draw on chart
function drawResults() {
	// Get results
	var text = tabs1.element("Results").value;
	var tt = Parse.getFrom(text).column(0);
	var RC = Parse.getFrom(text).column(1);
	var VC = Parse.getFrom(text).column(1);
	
	// Draw on related chart
	tabs2.graphic("xy").clear();
	tabs2.graphic("xy").setLineColor("#f00");	
	tabs2.graphic("xy").lines(tt, RC);
}

</script>
</body>
</html>