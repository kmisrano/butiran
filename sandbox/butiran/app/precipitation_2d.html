<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Precipitation_grid_2d</title>
<script src="../math/random.js"></script>
<script src="../color/rgb.js"></script>
<script src="../chart/xyseries.js"></script>
<script src="../chart/chart2.js"></script>
</head>
<body>
<script>
/*
Grid based discrete value precipitation model in 2d
Sparisoma Viridi | dudung@gmail.com
Rizal Kurniadi | rijalk@fi.itb.ac.id
Wahyu Srigutomo | wsrigutomo@gmail.com
Rita Sulistyowati | ritarahman08@gmail.com

20180403
Start this project.
Create following functions zeroMatrix, fillRandomSequence,
drawMatrixOnCanvas, animate, simulate, toggleButton,
normalizeMatrix, copyMatrix, sumOfMatrixElement, and test
all of them.
*/

// Define grid dimension and number of cells
var Ny = 100;
var Nx = 100;
var N = Nx * Ny;

// Generate random value for vapor value in each grid
var MAT = zeroMatrix(Ny, Nx);
var intMin = 0;
var intMax = 10;
var seq = randIntN(intMin, intMax, N);
fillRandomSequence(seq, MAT);

// Set maximum vapor value in each grid
// exceed this value the grid will drop to zero and
// the value will be converted to precipitation
var treshold = 15;

// Define canvas element
var can = document.createElement("canvas");
can.width = Nx;
can.height = Ny;
can.style.background = "#eee";
can.style.width = "200px";
can.style.height = "200px";

// Define button element
var btn = document.createElement("button");
btn.innerHTML = "Start";
btn.addEventListener("click", toggleButton);
var ANIMATING = false;

// Define break element
var brk = document.createElement("br");

// Define span element
var spn = document.createElement("span");
spn.style.fontFamily = "Courier";
spn.style.fontSize = "12px";

// Draw grid matrix in canvas
var colorMax = 20;
drawMatrixOnCanvas(MAT, can);

// Create canvas element for chart
var can2 = document.createElement("canvas");
can2.width = "500";
can2.height = "200";
can2.style.width = "500px";
can2.style.height = "200px";
can2.id = "drawingArea"
can2.style.background = "#f8f8f8";

var spc = document.createElement("span");
spc.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;";
	
// Set document layout
document.body.appendChild(can);
document.body.appendChild(spc);
document.body.appendChild(can2);
document.body.appendChild(brk);
document.body.appendChild(btn);
document.body.appendChild(spn);

// Create chart using Chart2 object
var dataX = [0];
var dataY = [0];
var series = new XYSeries("series1", dataX, dataY);
var chart = new Chart2("drawingArea");
chart.yAxis.Ntics = 4;
chart.xAxis.Ntics = 8;
chart.setXLabel("t");
chart.setYLabel("N");
chart.addSeries(series);
chart.drawSeries("series1");

// Perform simulation
function simulate(mat) {
	// Get matrix dimension
	var Ny = mat.length;
	var Nx = mat[0].length;
	
	// Generate random sequence
	var dx = randInt(-1, 1);
	var dy = randInt(-1, 1);
	
	// Move content of mat[c][r]
	var r = randInt(0, Ny - 1);
	var c = randInt(0, Nx - 1);
	
	// Prepare some texts
	var sum = sumOfMatrixElement(MAT);
	var text = "";
	
	// Move some water vapor if available
	if(mat[r][c] > 0) {
		var val = randInt(0, mat[r][c]);
		val = mat[r][c];
		mat[r][c] -= val;
		var cc = c + dx;
		var rr = r + dy;
		
		// Set periodic boundary condition
		if(cc > Nx - 1) {
			cc = 0;
		} else if(cc < 0) {
			cc = Nx - 1;
		}
		if(rr > Ny - 1) {
			rr = 0;
		} else if(rr < 0) {
			rr = Ny - 1;
		}
		
		// Add val to new location
		mat[rr][cc] += val;
		
		// Verbose process
		text = " " + sum + " | " + val + " ("
		+ r + ", " + c + ") -> " + "(" + rr + ", " + cc + ")";
	}
	spn.innerHTML = text;
}

// Animate
var iter = 0;
var iterMax = 100;
var t = 0;
function animate() {
	if(ANIMATING) {
		simulate(MAT);
		drawMatrixOnCanvas(MAT, can);
		if(iter > iterMax) {
			var precipitation = zeroMatrixElement(MAT, treshold);	
			dataX.push(t);
			dataY.push(precipitation);
			var series = new XYSeries("series1", dataX, dataY);
			chart.series = [];
			chart.addSeries(series);
			chart.drawSeries("series1");
			t++;
			iter = 0;
		}
		iter++;
		requestAnimationFrame(animate);
	}
}

// Toggle button event
function toggleButton() {
	var b = event.target;
	if(b.innerHTML == "Start") {
		ANIMATING = true;
		b.innerHTML = "Stop";
	} else {
		ANIMATING = false;
		b.innerHTML = "Start";
	}
	animate();
}

// Zero matrix element which has more than a value
function zeroMatrixElement(mat, treshold) {
	// Get matrix dimension
	var rows = mat.length;
	var cols = mat[0].length;
	
	// Sum matrix elements
	var precipitation = 0;
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			if(mat[r][c] > treshold) {
				precipitation += mat[r][c];
				mat[r][c] = 0;
			}
		}
	}
	return precipitation;
}

// Calculate sum of matrix elements
function sumOfMatrixElement(mat) {
	// Get matrix dimension
	var rows = mat.length;
	var cols = mat[0].length;
	
	// Sum matrix elements
	var sum = 0;
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			sum += mat[r][c];
		}
	}
	return sum;
}

// Copy matrix
function copyMatrix(mat) {
	// Get matrix dimension
	var rows = mat.length;
	var cols = mat[0].length;
	
	// Create new matrix
	var newmat = [];
	for(var r = 0; r < rows; r++) {
		var arow = [];
		for(var c = 0; c < cols; c++) {
			arow.push(mat[r][c]);
		}
		newmat.push(arow);
	}
	return newmat;
}

// Normalize value of each matrix element to 1
function normalizeMatrix(mat) {
	// Get matrix dimension
	var rows = mat.length;
	var cols = mat[0].length;
	
	// Get maximum value
	var max = 0;
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			max = (max < mat[r][c]) ? mat[r][c] : max;
		}
	}
	
	// Normalize all values with max
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			mat[r][c] = Math.round(1.0 * mat[r][c] / max);
		}
	}
}

// Draw content of 2d matrix in a canvas
function drawMatrixOnCanvas(m, can) {
	var ctx = can.getContext("2d");
	var rows = m.length;
	var cols = m[0].length;
	
	var mat = copyMatrix(m);
	//normalizeMatrix(mat);
	
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			var red = (1 - mat[r][c] / colorMax);
			var green = (1 - mat[r][c] / colorMax);
			var blue = 1;
			var color = double2rgb(red, green, blue);
			ctx.fillStyle = color;
			ctx.fillRect(c, r, 1, 1);
		}
	}
	ctx.stroke();
}

// Fill sequence of random number to 2d array
function fillRandomSequence(seq, m) {
	var N = seq.length;
	var rows = m.length;
	var cols = m[0].length;
	var i = 0;
	for(var r = 0; r < rows; r++) {
		for(var c = 0; c < cols; c++) {
			m[r][c] = seq[i];
			i++;
		}
	}
}

// Define matrix with value 0
function zeroMatrix(rows, cols) {
	var zero = [];
	for(var r = 0; r < rows; r++) {
		var arow = [];
		for(var c = 0; c < cols; c++) {
			arow.push(0);
		}
		zero.push(arow);
	}
	return zero;
}

</script>
</body>
</html>
