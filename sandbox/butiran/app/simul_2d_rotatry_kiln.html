<!DOCTYPE html>
<html>
	<head>
		<meta charset="ISO-8859-1">
		<title>Simulation of 2D Rotary Kiln</title>
		<script src="../grains/vect3old.js"></script>
		<script src="../grains/grain.js"></script>
		<script src="../grains/force.js"></script>
		<script src="../grains/mdynamics.js"></script>
		<script src="../grains/draw2d.js"></script>
	</head>
	<body>
		<script>
		/*
			indexLiner.html
			Simulate 2D Rotary Kiln
			Sparisoma Viridi | dudung@gmail.com
			Putri Mustika Widartiningsih | putrimw.itb@gmail.com
			
			20170628
			Start this HTML (create liner)
			20170703
			Add grains
			20180327
			Rename vect3.js to vect3old.js, integrate layout.js to
			this file, and change value dt in this file.
			Also redefine forces constants.
		*/
			
			// Redefine some constants from force.js
			kG = 5E0;
			kR = 1E5;
			kV = 1.0;
			kE = 1.0;
			kV2 = 40.0;
			kG2 = new Vect3(0, -10, 0);
			
			// Override value from mdynamics.js
			dt = 0.01;
			
			var timer1;
			var TTMAX = 10;
			var liner = new Array(NL);
			var grains = new Array(NG);
			var x = new Array(NL);
			var y = new Array(NL);
			var xx = new Array(NL);
			var yy = new Array(NL);
			var Theta = new Array(NL);
			
			var RM = 35;
			var NL = 20;
			var NG = 25;
			var N = NL + NG;
			
			var theta = 2*Math.PI/NL;
			var w = -0.8;
			var x0 = -60;
			var y0 = -60;
			
			layout();
			initiate();
			
			function initiate() {
				Mdynamics.setdt(1E-3);
				
				var mL = 1;
				var cL = "#00f";
				var mG = 40;
				var cG = "#f00";
				
				var DL = 2 * RM * Math.sin(Math.PI / NL);
				var DG = 6;
				var i = 0;
				
				for (var ix=0; ix<N; ix++) {
					grains[i] = new Grain;
					grains[i].i = i+1;
					if(i < NL) {
						Theta[i] = i*theta + w*t;
						x[i] = RM * Math.cos(Theta[i]);
						y[i] = RM * Math.sin(Theta[i]);
						grains[i].r = new Vect3(x[i],y[i],0);
						grains[i].m = mL;
						grains[i].c = cL;
						grains[i].D = DL;
						//console.log(grains[i].D+"\n");
					} else {						
						grains[i].m = mG;
						grains[i].c = cG;
						grains[i].D = DG;
					}
					i++;
				}
				
				
				var ii = 0;
				var Nx = Math.sqrt(NG);
				var Ny = NG / Nx;
				for(var iy = 0; iy < Ny; iy++) {
					for(var ix = 0; ix < Nx; ix++) {
						var xx = (ix - 0.4 * Nx) * 1.1 * DG;
						var yy = (iy - 0.4 * Ny) * 1.1 * DG;
						grains[ii + NL].r = new Vect3(xx, yy, 0);
						ii++;
					}
				}

				for(var iG = 0; iG < N; iG++) {
					if(i >= NL) {
						plotLiner(grains[iG]);
					} else {
						plotParticle(grains[iG]);
					}
				}
			}
			
			function run() {
				// Prepare variabel for saving sum of forces
				var SF = new Array(N);
				for(var iN = NL; iN < N; iN++) {
					SF[iN] = new Vect3;
				}
				
				// Calculate viscous force
				for(var iN = NL; iN < N; iN++) {
					var f = Force.visc(grains[iN]);
					SF[iN] = Vect3.add(SF[iN], f);
				}
				
				// Calculate gravitation force
				for(var iN = NL; iN < N; iN++) {
					var f = Force.grav2(grains[iN]);
					SF[iN] = Vect3.add(SF[iN], f);
				}

				
				// Calculate normal force
				for(var iN = NL; iN < N; iN++) {
					for(var jN = 0; jN < N; jN++) {
						var f = new Vect3;
						if(jN != iN) {
							f = Force.norm(grains[iN], grains[jN]);
							SF[iN] = Vect3.add(SF[iN], f);
						}
					}
				}
				
				var str = "t = " + t.toFixed(3) + " s";
				var hout = document.getElementById("hout");
				hout.innerHTML = str;
				
				if(TT == TTMAX) {
					clearCurrentFigure();
					for(var iN = 0; iN < N; iN++) {
						plotParticle(grains[iN]);
					}
					TT = 0;
				}
				
				for(var iN = NL; iN < N; iN++) {
					Mdynamics.Euler(SF[iN], grains[iN]);
				}
				Mdynamics.inct();
				
				for(var iN = 0; iN < NL; iN++) {
					var x = grains[iN].r.x;
					var y = grains[iN].r.y;
					theta2 = Math.atan(y / x);
					if(y <= 0) {
						theta2 += Math.PI;
					}
					theta2 = theta2 + w * dt;
					var x = RM * Math.cos(theta2);
					var y = RM * Math.sin(theta2);
					grains[iN].r.x = x;
					grains[iN].r.y = y;
				}	
			}
			
			/*
			layout.js
			Define layout for simulation.
			Sparisoma Viridi | dudung@gmail.com
			
			20170215
			Start this library.
			20180327
			Delete this file and move to simul_2d_rotatry_kiln.html
			*/
			function layout() {
				// Create left division
				var ldiv = document.createElement("div");
				document.body.appendChild(ldiv);
				ldiv.style.border = "0px black solid";
				ldiv.style.height = "402px";
				ldiv.style.float = "left";
				ldiv.style.width = "252px";
				
				// Create right division
				var rdiv = document.createElement("div");
				document.body.appendChild(rdiv);
				rdiv.style.border = "0px black solid";
				rdiv.style.height = "402px";
				rdiv.style.float = "left";
				
				// Create text area for input
				var ta = document.createElement("textarea");
				ldiv.appendChild(ta);
				ta.style.color = "black";
				ta.style.background = "white";
				ta.rows = "2";
				ta.cols = "32";
				//ta.style.overflowY = "scroll";
				ta.style.display = "block";	
				ta.id = "hout";
				
				var res = document.createElement("textarea");
				//	ldiv.appendChild(res);
				res.style.color = "black";
				res.style.background = "white";
				res.rows = "35";
				res.cols = "32";
				res.style.overflowY = "scroll";
				res.style.display = "block";	
				res.id = "result";
				res.value = "";
				
				// Create canvas for drawing
				var c = document.createElement("canvas");
				rdiv.appendChild(c);
				c.id = "canvas";
				c.style.border = "1px solid #999";
				c.style.background = "white";
				c.width = "600";
				c.height = "600";
				//c.style.float = "left";
				var ctx = c.getContext("2d");
				
				// Prepare canvas
				setCanvasCoordinates("canvas");
				setWorldCoordinates(-41, -41, 41, 41);
				
				// Create start button
				var b1 = document.createElement("button");
				ldiv.appendChild(b1);
				b1.innerHTML = "Start";
				b1.onclick = function() {
					if(b1.innerHTML == "Start") {
						b1.innerHTML = "Stop";
						timer1 = setInterval(run, 1);
					} else {
						b1.innerHTML = "Start";
						clearInterval(timer1);
					}
				}
				
				// Create save Button
				var b2 = document.createElement("button");
				ldiv.appendChild(b2);
				b2.innerHTML = "Save";
				b2.onclick = function() {
					var canvas = document.getElementById("canvas");
					var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
					window.location.href = image;
				}
			}
		</script>
	</body>
</html>
